<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Little Wins — Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="css/style.css">
  <script src="/frontend/config.js"></script>
</head>
<body>
  <main class="card">

    <h1>Little Wins — Home</h1>
    <p id="welcome-text"></p>

    <!-- MINI MENU / TABS -->
    <nav class="tabs" aria-label="Home menu">
      <button class="tab-btn is-active" data-tab="tab-session" type="button">Start Session</button>
      <button class="tab-btn" data-tab="tab-reminders" type="button">Reminders</button>
      <button class="tab-btn" data-tab="tab-stats" type="button">Stats</button>

      <button onclick="location.href='gallery.html'">Gallery</button>

    </nav>

    <!-- TAB: START SESSION -->
    <section id="tab-session" class="tab-panel is-active" aria-live="polite">
      <h2>Start a Little Wins Session</h2>

      <div>
        <label for="mode-select">Mode:</label>
        <select id="mode-select">
          <!-- IMPORTANT: values MUST match DB exactly -->
          <option value="Mood Booster">Mood Booster</option>
          <option value="Brain Booster">Brain Booster</option>
          <option value="Relax & Reset">Relax & Reset</option>
          <option value="Kindness & Connection">Kindness & Connection</option>
        </select>
      </div>

      <div>
        <label for="duration-select">Duration (minutes):</label>
        <select id="duration-select">
          <option value="3">3</option>
          <option value="5" selected>5</option>
          <option value="10">10</option>
          <option value="15">15</option>
        </select>
      </div>

      <div class="controls">
        <button id="start-session-btn" type="button">Start Session</button>
      </div>
    </section>

    <!-- TAB: REMINDERS -->
    <section id="tab-reminders" class="tab-panel">
      <h2>Reminders</h2>
      <p>Coming soon ✨</p>
    </section>

    <!-- TAB: STATS -->
    <section id="tab-stats" class="tab-panel">
      <h2>Stats</h2>
      <div class="controls">
        <button id="stats-btn" type="button">Open Stats</button>
      </div>
    </section>

    <!-- FOOTER ACTION -->
    <div class="footer-actions">
      <button id="logout-btn" class="btn-secondary" type="button">Logout</button>
    </div>

  </main>

<script>
/* =======================
   BASIC SETUP
======================= */
const API_BASE = window.LW_CONFIG?.API_BASE || 'http://localhost:3000/api';
const token = localStorage.getItem('lw_token');

if (!token) location.href = 'index.html';

/* =======================
   API HELPER
======================= */
async function api(path, opts = {}) {
  const headers = opts.headers || {};
  headers['Content-Type'] = 'application/json';
  headers['Authorization'] = 'Bearer ' + token;

  const res = await fetch(API_BASE + path, { ...opts, headers });

  if (res.status === 401) {
    localStorage.clear();
    location.href = 'index.html';
    throw new Error('Unauthorized');
  }
  return res;
}

/* =======================
   TAB LOGIC
======================= */
const tabButtons = document.querySelectorAll('.tab-btn');
const tabPanels = document.querySelectorAll('.tab-panel');

function openTab(panelId) {
  tabButtons.forEach(b => b.classList.toggle('is-active', b.dataset.tab === panelId));
  tabPanels.forEach(p => p.classList.toggle('is-active', p.id === panelId));
}

tabButtons.forEach(btn => {
  btn.addEventListener('click', () => openTab(btn.dataset.tab));
});

/* =======================
   LOAD USER
======================= */
(async () => {
  try {
    const r = await api('/me');
    const data = await r.json();
    document.getElementById('welcome-text').textContent =
      `Welcome back, ${data.user.username}!`;
  } catch {
    const name = localStorage.getItem('lw_username') || 'Little Wins user';
    document.getElementById('welcome-text').textContent =
      `Welcome back, ${name}!`;
      
  }
})();

/* =======================
   LOGOUT / STATS
======================= */
document.getElementById('logout-btn').onclick = () => {
  localStorage.clear();
  sessionStorage.clear();
  location.href = 'index.html';
};

document.getElementById('stats-btn').onclick = () => {
  location.href = 'stats.html';
};

/* =======================
   START SESSION (FIXED)
======================= */
document.getElementById('start-session-btn').addEventListener('click', async () => {
  const mode = document.getElementById('mode-select').value;
  const duration = document.getElementById('duration-select').value;

  try {
    const qs = `?mode=${encodeURIComponent(mode)}&duration=${encodeURIComponent(duration)}`;
    const res = await api('/activities' + qs);
    const data = await res.json();

    if (!res.ok || !data.activity) {
      alert(data.error || 'No activity found');
      return;
    }

    sessionStorage.setItem('currentMode', mode);
    sessionStorage.setItem('currentDuration', duration);
    sessionStorage.setItem('currentActivity', JSON.stringify(data.activity));

    location.href = 'activity.html';

  } catch (err) {
    console.error(err);
    alert('Error fetching activity');
  }
});
</script>

</body>
</html>
