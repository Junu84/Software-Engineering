<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Little Wins — Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="css/style.css">
  <script src="/frontend/config.js"></script>
</head>
<body>
  <main class="card">
    <h1>Little Wins — Home</h1>
    <p id="welcome-text"></p>

    <h2>Start a Little Wins Session</h2>

    <div>
      <label for="mode-select">Mode:</label>
      <select id="mode-select">
        <option value="Mood Booster">Mood Booster</option>
        <option value="Brain Booster">Brain Booster</option>
        <option value="Relax & Reset">Relax & Reset</option>
        <option value="Kindness & Connection">Kindness & Connection</option>
      </select>
    </div>

    <div>
      <label for="duration-select">Duration (minutes):</label>
      <select id="duration-select">
        <option value="3">3</option>
        <option value="5" selected>5</option>
        <option value="10">10</option>
        <option value="15">15</option>
      </select>
    </div>

    <button id="start-session-btn">Start Session</button>
    <hr />
    <button id="logout-btn">Logout</button>
  </main>

  <script>
    const API_BASE = window.LW_CONFIG?.API_BASE || 'http://localhost:3000/api';;
    const token = localStorage.getItem('lw_token');

    if (!token) {
      window.location.href = 'index.html';
    }

    async function api(path, opts = {}) {
      const headers = opts.headers || {};
      headers['Content-Type'] = 'application/json';
      headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(API_BASE + path, { ...opts, headers });
      if (res.status === 401) {
        localStorage.removeItem('lw_token');
        window.location.href = 'index.html';
        throw new Error('Unauthorized');
      }
      return res;
    }

    // display welcome name (try API /me for verification)
    (async function loadUser(){
      try {
        const r = await api('/me');
        const data = await r.json();
        document.getElementById('welcome-text').textContent = `Welcome back, ${data.user.username}!`;
      } catch (err) {
        // fallback to saved username
        const name = localStorage.getItem('lw_username') || 'Little Wins user';
        document.getElementById('welcome-text').textContent = `Welcome back, ${name}!`;
      }
    })();

    document.getElementById('logout-btn').addEventListener('click', () => {
      localStorage.removeItem('lw_token');
      localStorage.removeItem('lw_username');
      sessionStorage.removeItem('currentMode');
      sessionStorage.removeItem('currentDuration');
      sessionStorage.removeItem('currentActivity');
      window.location.href = 'index.html';
    });

    document.getElementById('start-session-btn').addEventListener('click', async () => {
      const mode = document.getElementById('mode-select').value;
      const duration = document.getElementById('duration-select').value;

      try {
        // request one matching activity from backend
        const qs = `?mode=${encodeURIComponent(mode)}&duration=${encodeURIComponent(duration)}`;
        const r = await api('/activities' + qs);
        const data = await r.json();
        if (!r.ok) {
          alert(data.error || 'Could not fetch activity');
          return;
        }
        // store transient session info in sessionStorage
        sessionStorage.setItem('currentMode', mode);
        sessionStorage.setItem('currentDuration', duration);
        if (!data.activity || !data.activity.id) {
          alert('Could not fetch activity');
          return;
        }
        sessionStorage.setItem('currentActivity', JSON.stringify(data.activity));

        // go to activity page
        window.location.href = 'activity.html';
      } catch (err) {
        console.error(err);
        alert('Error fetching activity');
      }
    });
  </script>
</body>
</html>