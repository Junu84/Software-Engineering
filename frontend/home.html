<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Little Wins ‚Äî Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="css/style.css">
  <script src="/frontend/config.js"></script>
</head>
<body>
  <main class="card">

      <h1>Little Wins ‚Äî Home</h1>
      <p id="welcome-text"></p>

      <!-- MINI MENU / TABS -->
      <nav class="tabs" aria-label="Home menu">
        <button class="tab-btn is-active" data-tab="tab-session" type="button">Start Session</button>
        <button class="tab-btn" data-tab="tab-reminders" type="button">Reminders</button>
        <button class="tab-btn" data-tab="tab-stats" type="button">Stats</button>
      </nav>

      <!-- TAB: START SESSION -->
      <section id="tab-session" class="tab-panel is-active" aria-live="polite">
        <h2>Start a Little Wins Session</h2>

        <div>
          <label for="mode-select">Mode:</label>
          <select id="mode-select">
            <option value="Mood Booster">Mood Booster</option>
            <option value="Brain Booster">Brain Booster</option>
            <option value="Relax & Reset">Relax & Reset</option>
            <option value="Kindness & Connection">Kindness & Connection</option>
          </select>
        </div>

        <div>
          <label for="duration-select">Duration (minutes):</label>
          <select id="duration-select">
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="15">15</option>
          </select>
        </div>

        <div class="controls">
          <button id="start-session-btn" type="button">Start Session</button>
        </div>
      </section>

      <!-- TAB: REMINDERS -->
      <section id="tab-reminders" class="tab-panel" aria-live="polite">
        <h2>Reminders</h2>

        <div class="controls">
          <button id="enable-notifications-btn" type="button">Enable notifications</button>
        </div>

        <div style="margin-top:12px;">
          <label for="remind-time"><strong>Remind me at:</strong></label><br />
          <input id="remind-time" type="time" />

        <div class="controls" style="margin-top:10px;">
          <button id="save-reminder-btn" type="button">Save daily reminder</button>
          <button id="clear-reminder-btn" type="button">Clear</button>
        </div>
  
        </div>

        <p id="notify-status" aria-live="polite"></p>
      </section>

      <!-- TAB: STATS -->
      <section id="tab-stats" class="tab-panel" aria-live="polite">
        <h2>Stats</h2>
        <p>Your progress is saved ‚Äî want to see the last 7 days?</p>

        <div class="controls">
          <button id="stats-btn" type="button">Open Stats</button>
        </div>
      </section>

      <!-- FOOTER ACTION -->
      <div class="footer-actions">
        <button id="logout-btn" class="btn-secondary" type="button">Logout</button>
      </div>
  </main>

  <script>
    const API_BASE = window.LW_CONFIG?.API_BASE || 'http://localhost:3000/api';;
    const token = localStorage.getItem('lw_token');

    if (!token) {
      window.location.href = 'index.html';
    }

    async function api(path, opts = {}) {
      const headers = opts.headers || {};
      headers['Content-Type'] = 'application/json';
      headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(API_BASE + path, { ...opts, headers });
      if (res.status === 401) {
        localStorage.removeItem('lw_token');
        window.location.href = 'index.html';
        throw new Error('Unauthorized');
      }
      return res;
    }
      // --- Tab logic ---
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabPanels = document.querySelectorAll('.tab-panel');

      function openTab(panelId) {
        tabButtons.forEach(b => b.classList.toggle('is-active', b.dataset.tab === panelId));
        tabPanels.forEach(p => p.classList.toggle('is-active', p.id === panelId));
      }

      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => openTab(btn.dataset.tab));
      });


    // display welcome name (try API /me for verification)
    (async function loadUser(){
      try {
        const r = await api('/me');
        const data = await r.json();
        document.getElementById('welcome-text').textContent = `Welcome back, ${data.user.username}!`;
      } catch (err) {
        // fallback to saved username
        const name = localStorage.getItem('lw_username') || 'Little Wins user';
        document.getElementById('welcome-text').textContent = `Welcome back, ${name}!`;
      }
    })();

    document.getElementById('logout-btn').addEventListener('click', () => {
      localStorage.removeItem('lw_token');
      localStorage.removeItem('lw_username');
      sessionStorage.removeItem('currentMode');
      sessionStorage.removeItem('currentDuration');
      sessionStorage.removeItem('currentActivity');
      window.location.href = 'index.html';
    });

    document.getElementById('stats-btn').addEventListener('click', () => {
      window.location.href = 'stats.html';
    });


    document.getElementById('start-session-btn').addEventListener('click', async () => {
      const mode = document.getElementById('mode-select').value;
      const duration = document.getElementById('duration-select').value;

      try {
        // request one matching activity from backend
        const qs = `?mode=${encodeURIComponent(mode)}&duration=${encodeURIComponent(duration)}`;
        const r = await api('/activities' + qs);
        const data = await r.json();
        if (!r.ok) {
          alert(data.error || 'Could not fetch activity');
          return;
        }
        // store transient session info in sessionStorage
        sessionStorage.setItem('currentMode', mode);
        sessionStorage.setItem('currentDuration', duration);
        if (!data.activity || !data.activity.id) {
          alert('Could not fetch activity');
          return;
        }
        sessionStorage.setItem('currentActivity', JSON.stringify(data.activity));

        // go to activity page
        window.location.href = 'activity.html';
      } catch (err) {
        console.error(err);
        alert('Error fetching activity');
      }
    });

    //NOTIFICATIONS
    const enableBtn = document.getElementById('enable-notifications-btn');
    const saveBtn = document.getElementById('save-reminder-btn');
    const clearBtn = document.getElementById('clear-reminder-btn');
    const remindTime = document.getElementById('remind-time');
    const notifyStatus = document.getElementById('notify-status');

    let reminderTimeoutId = null;

    function canNotify() {
      return 'Notification' in window;
    }

    function readSavedTime() {
      return localStorage.getItem('lw_daily_reminder_time'); // e.g. "17:00"
    }

    function saveTime(t) {
      localStorage.setItem('lw_daily_reminder_time', t);
    }

    function clearTime() {
      localStorage.removeItem('lw_daily_reminder_time');
    }

    // milliseconds until the next occurrence of hh:mm
    function msUntilNext(hh, mm) {
      const now = new Date();
      const target = new Date();
      target.setSeconds(0, 0);
      target.setHours(hh, mm, 0, 0);

      // if target time already passed today, schedule for tomorrow
      if (target.getTime() <= now.getTime()) {
        target.setDate(target.getDate() + 1);
      }

      return target.getTime() - now.getTime();
    }

    function scheduleDailyReminder(timeStr) {
      // clear old timeout if any
      if (reminderTimeoutId) {
        clearTimeout(reminderTimeoutId);
        reminderTimeoutId = null;
      }

      if (!timeStr) return;

      if (!canNotify()) {
        notifyStatus.textContent = "Notifications are not supported in this browser.";
        return;
      }

      if (Notification.permission !== 'granted') {
        notifyStatus.textContent = "Please enable notifications first.";
        return;
      }

      const [hh, mm] = timeStr.split(':').map(Number);
      const delay = msUntilNext(hh, mm);

      notifyStatus.textContent = `‚úÖ Daily reminder set for ${timeStr}. (Next one scheduled.)`;

      reminderTimeoutId = setTimeout(() => {
        new Notification("Little Wins ‚ú®", {
          body: "Ready for a quick session? It only takes a few minutes üíú",
        });

        // schedule again for the next day automatically
        scheduleDailyReminder(timeStr);
      }, delay);
    }

    enableBtn.addEventListener('click', async () => {
      if (!canNotify()) {
        notifyStatus.textContent = "Notifications are not supported in this browser.";
        return;
      }

      const result = await Notification.requestPermission();
      if (result === 'granted') {
        notifyStatus.textContent = "‚úÖ Notifications enabled!";
        // if user already saved a time, schedule immediately
        const t = readSavedTime();
        if (t) scheduleDailyReminder(t);
      } else {
        notifyStatus.textContent = "‚ùå Notifications blocked. You can allow them in browser settings.";
      }
    });

    saveBtn.addEventListener('click', () => {
      const t = remindTime.value; // "17:00"
      if (!t) {
        notifyStatus.textContent = "Please choose a time first.";
        return;
      }

      saveTime(t);
      scheduleDailyReminder(t);
    });

    clearBtn.addEventListener('click', () => {
      clearTime();
      if (reminderTimeoutId) clearTimeout(reminderTimeoutId);
      reminderTimeoutId = null;
      notifyStatus.textContent = "üßπ Reminder cleared.";
    });

    // On page load: show saved time + schedule it (if possible)
    (function initReminderUI() {
      const saved = readSavedTime();
      if (saved) {
        remindTime.value = saved;
        if (canNotify() && Notification.permission === 'granted') {
          scheduleDailyReminder(saved);
        } else {
          notifyStatus.textContent = `‚ÑπÔ∏è Saved daily reminder time: ${saved}. Enable notifications to activate it.`;
        }
      }
    })();



  </script>
</body>
</html>