<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Little Wins â€” Activity</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="css/style.css">
  <script src="/frontend/config.js"></script>
</head>
<body>
  <main class="card">
    <h1>Your Little Wins Activity</h1>
    <p id="session-info" aria-live="polite"></p>

    <section id="activity-area" class="activity" aria-live="polite">
      <h2 id="activity-title"></h2>
      <div id="activity-desc"></div>
    </section>

    <div class="controls">
      <button id="another-btn">Show another activity</button>
      <button id="done-btn">Done</button>
      <button id="back-home-btn">Back to Home</button>
    </div>

    <div id="summary" class="hidden" aria-live="polite">
      <h3>Well done!</h3>
      <div id="summary-details"></div>
      <button id="add-photo-btn">Add photo (optional)</button>
      <input id="photo-input" type="file" accept="image/*" capture="environment" class="hidden" />
    </div>
  </main>

  <script>
    const API_BASE = window.LW_CONFIG?.API_BASE || 'http://localhost:3000/api';
    const token = localStorage.getItem('lw_token');
    if (!token) window.location.href = 'index.html';

    const mode = sessionStorage.getItem('currentMode');
    const duration = sessionStorage.getItem('currentDuration');
    let currentActivity = sessionStorage.getItem('currentActivity')
      ? JSON.parse(sessionStorage.getItem('currentActivity'))
      : null;

    const startedAt = new Date().toISOString();

    if (!mode || !duration) window.location.href = 'home.html';

    const sessionInfo = document.getElementById('session-info');
    const titleEl = document.getElementById('activity-title');
    const descEl = document.getElementById('activity-desc');
    const anotherBtn = document.getElementById('another-btn');
    const doneBtn = document.getElementById('done-btn');
    const backHomeBtn = document.getElementById('back-home-btn');
    const addPhotoBtn = document.getElementById('add-photo-btn');
    const photoInput = document.getElementById('photo-input');
    const summaryEl = document.getElementById('summary');
    const summaryDetails = document.getElementById('summary-details');

    sessionInfo.textContent = `Mode: ${mode} â€¢ Duration: ${duration} min`;

    async function api(path, opts = {}) {
      const headers = opts.headers || {};
      headers['Content-Type'] = 'application/json';
      headers['Authorization'] = 'Bearer ' + token;

      const res = await fetch(API_BASE + path, { ...opts, headers });
      if (res.status === 401) {
        localStorage.removeItem('lw_token');
        window.location.href = 'index.html';
        throw new Error('Unauthorized');
      }
      return res;
    }

    // Render activity (shows type and payload if available)
    function renderActivity() {
      if (!currentActivity) {
        titleEl.textContent = '(No activity)';
        descEl.textContent = '';
        return;
      }

      titleEl.textContent = currentActivity.title;

      const type = currentActivity.activity_type || 'generic';
      const payload = currentActivity.payload ? JSON.stringify(currentActivity.payload) : null;

      descEl.innerHTML =
        `<p><strong>Type:</strong> ${type}</p>` +
        `<p>${currentActivity.description || ''}</p>` +
        (payload ? `<p><small><strong>Payload:</strong> ${payload}</small></p>` : '');

      summaryEl.classList.add('hidden');
    }

    async function loadActivity(excludeId) {
      try {
        const q =
          `?mode=${encodeURIComponent(mode)}&duration=${encodeURIComponent(duration)}` +
          (excludeId ? `&excludeId=${encodeURIComponent(excludeId)}` : '');

        const r = await api('/activities' + q);
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Could not load activity');

        currentActivity = data.activity;

        // IMPORTANT: payload comes as TEXT from DB, depending on your service.
        // If it arrives as a string, parse it:
        if (currentActivity && typeof currentActivity.payload === 'string') {
          try { currentActivity.payload = JSON.parse(currentActivity.payload); } catch {}
        }

        sessionStorage.setItem('currentActivity', JSON.stringify(currentActivity));
        renderActivity();
      } catch (err) {
        titleEl.textContent = 'Could not load activity';
        descEl.textContent = err.message || '';
      }
    }

    anotherBtn.addEventListener('click', async () => {
      if (!currentActivity) return;
      await loadActivity(currentActivity.id);
    });

    // SENSOR LOGIC (isolated) â€” this is S6
    async function runSensorIfNeeded() {
      if (!currentActivity || currentActivity.activity_type !== 'sensor') return null;

      const payload = currentActivity.payload || {};

      // 1) Motion (shake)
      if (payload.sensor === 'motion') {
        return new Promise(resolve => {
          let gotEvent = false;

          function handler(e) {
            gotEvent = true;
            window.removeEventListener('devicemotion', handler);

            resolve({
              sensor: 'motion',
              acceleration: e.accelerationIncludingGravity || null,
              message: 'Motion detected âœ…'
            });
          }

          window.addEventListener('devicemotion', handler, { once: true });

          setTimeout(() => {
            if (!gotEvent) resolve({ sensor: 'motion', message: 'No motion data (maybe desktop / blocked)' });
          }, 3000);
        });
      }

      // 2) Geolocation (GPS)
      if (payload.sensor === 'geolocation') {
        if (!navigator.geolocation) {
          return { sensor: 'geolocation', message: 'Geolocation not supported in this browser' };
        }

        return new Promise(resolve => {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              resolve({
                sensor: 'geolocation',
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                accuracy: pos.coords.accuracy,
                message: 'Location captured âœ…'
              });
            },
            (err) => {
              resolve({
                sensor: 'geolocation',
                message: 'Location blocked / not available',
                error: err.message
              });
            },
            {
              enableHighAccuracy: payload.accuracy === 'high',
              timeout: 8000,
              maximumAge: 0
            }
          );
        });
      }

      return { message: 'Unknown sensor type' };
    }

    // Done = runs sensor if needed + sends sensorResult to backend
    doneBtn.addEventListener('click', async () => {
      if (!currentActivity) return;

      const completedAt = new Date().toISOString();

      const sensorResult = await runSensorIfNeeded();

      const payload = {
        mode,
        duration: Number(duration),
        activityId: currentActivity.id,
        activityTitle: currentActivity.title,
        startedAt,
        completedAt,
        sensorResult
      };

      try {
        const r = await api('/sessions', { method: 'POST', body: JSON.stringify(payload) });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Failed to save session');
        showSummary(data.session, sensorResult);
      } catch (err) {
        alert('Could not save session: ' + (err.message || ''));
      }
    });

    function showSummary(session, sensorResult) {
      summaryEl.classList.remove('hidden');
      summaryDetails.innerHTML = '';

      const p1 = document.createElement('p');
      p1.textContent = `Mode: ${session.mode} â€¢ Duration: ${session.duration} min`;

      const p2 = document.createElement('p');
      p2.textContent = `Activity: ${session.activity_title || session.activityTitle || ''}`;

      const p3 = document.createElement('p');
      p3.textContent = `Completed: ${new Date(session.completed_at).toLocaleString()}`;

      summaryDetails.appendChild(p1);
      summaryDetails.appendChild(p2);
      summaryDetails.appendChild(p3);

      // show sensor result if we have one
      if (sensorResult) {
        const pre = document.createElement('pre');
        pre.style.whiteSpace = 'pre-wrap';
        pre.textContent = 'Sensor result:\n' + JSON.stringify(sensorResult, null, 2);
        summaryDetails.appendChild(pre);
      }

      // Motivational message
      const messages = [
        "Great job! ðŸŒŸ",
        "Every little win counts ðŸ’œ",
        "You did something good for yourself!",
        "Well done â€” keep going ðŸ’ª"
      ];
      const msg = messages[Math.floor(Math.random() * messages.length)];
      const p4 = document.createElement('p');
      p4.textContent = msg;
      summaryDetails.appendChild(p4);

      // show photo if exists
      if (session.photo) {
        const img = document.createElement('img');
        img.src = session.photo;
        img.style.maxWidth = '100%';
        summaryDetails.appendChild(img);
      }

      if (session.id) localStorage.setItem('lw_lastSessionId', session.id);
    }

    addPhotoBtn.addEventListener('click', () => photoInput.click());

    photoInput.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f || !currentActivity) return;

      const reader = new FileReader();
      reader.onload = async (ev) => {
        const dataUrl = ev.target.result;
        const completedAt = new Date().toISOString();

        const sensorResult = await runSensorIfNeeded();

        const payload = {
          mode,
          duration: Number(duration),
          activityId: currentActivity.id,
          activityTitle: currentActivity.title,
          startedAt,
          completedAt,
          photo: dataUrl,
          sensorResult
        };

        try {
          const r = await api('/sessions', { method: 'POST', body: JSON.stringify(payload) });
          const data = await r.json();
          if (!r.ok) throw new Error(data.error || 'Could not save session with photo');
          showSummary(data.session, sensorResult);
        } catch (err) {
          alert('Could not save session with photo');
        }
      };

      reader.readAsDataURL(f);
    });

    backHomeBtn.addEventListener('click', () => {
      sessionStorage.removeItem('currentMode');
      sessionStorage.removeItem('currentDuration');
      sessionStorage.removeItem('currentActivity');
      window.location.href = 'home.html';
    });

    if (currentActivity) {
      // payload might be string from storage â†’ parse it
      if (typeof currentActivity.payload === 'string') {
        try { currentActivity.payload = JSON.parse(currentActivity.payload); } catch {}
      }
      renderActivity();
    } else {
      loadActivity().catch(() => {});
    }
  </script>
</body>
</html>
