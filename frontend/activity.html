<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Little Wins â€” Activity</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="css/style.css">
  <script src="config.js"></script>
</head>
<body>

<main class="card">
  <h1>Your Little Wins Activity</h1>
  <p id="session-info"></p>

  <!-- ACTIVITY -->
  <section id="activity-area">
    <h2 id="activity-title"></h2>
    <div id="activity-desc"></div>
  </section>

  <!-- CONTROLS -->
  <div id="controls">
    <button type="button" id="another-btn">Show another activity</button>
    <button type="button" id="done-btn">Done</button>
    <button type="button" id="back-home-btn">Back to Home</button>
  </div>

  <!-- SUMMARY -->
  <section id="summary" class="hidden">
    <h3>Well done! ðŸŽ‰</h3>
    <div id="summary-details"></div>

    <h4>Add a memory photo (optional)</h4>

    <!-- CAMERA -->
    <video id="camera" autoplay playsinline style="display:none; width:100%; border-radius:8px;"></video>
    <canvas id="snapshot" style="display:none;"></canvas>

    <div style="margin-top:10px;">
      <button type="button" id="open-camera-btn">Open Camera</button>
      <button type="button" id="take-photo-btn" style="display:none;">Take Photo</button>
    </div>

    <!-- FILE UPLOAD -->
    <input id="photo-input" type="file" accept="image/*" style="margin-top:10px;">

    <img id="photo-preview" style="display:none; max-width:100%; margin-top:10px; border-radius:8px;">

    <button type="button" id="save-photo-btn" style="margin-top:12px;">
      Save & Finish
    </button>
  </section>
</main>

<script>
/* =======================
   BASIC SETUP
======================= */
const API_BASE = window.LW_CONFIG?.API_BASE || 'http://localhost:3000/api';
const token = localStorage.getItem('lw_token');
if (!token) location.href = 'index.html';

const mode = sessionStorage.getItem('currentMode');
const duration = sessionStorage.getItem('currentDuration');
if (!mode || !duration) location.href = 'home.html';

<<<<<<< HEAD
const startedAt = new Date().toISOString();
let currentActivity = null;
let finished = false;
let photoBase64 = null;
=======
    const sessionInfo = document.getElementById('session-info');
    const titleEl = document.getElementById('activity-title');
    const descEl = document.getElementById('activity-desc');
    const anotherBtn = document.getElementById('another-btn');
    const doneBtn = document.getElementById('done-btn');
    const backHomeBtn = document.getElementById('back-home-btn');
    const addPhotoBtn = document.getElementById('add-photo-btn');
    const photoInput = document.getElementById('photo-input');
    const summaryEl = document.getElementById('summary');
    summaryEl.classList.add('hidden');
    const summaryDetails = document.getElementById('summary-details');
>>>>>>> 517e5f0d1088e15bee0d223420373f571158bf90

/* =======================
   API HELPER
======================= */
async function api(path, opts = {}) {
  const res = await fetch(API_BASE + path, {
    ...opts,
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    }
  });

  if (res.status === 401) {
    localStorage.clear();
    location.href = 'index.html';
    throw new Error('Unauthorized');
  }

  return res.json();
}

/* =======================
   UI SETUP
======================= */
document.getElementById('session-info').textContent =
  `Mode: ${mode} â€¢ Duration: ${duration} min`;

function renderActivity() {
  if (!currentActivity) return;
  document.getElementById('activity-title').textContent = currentActivity.title;
  document.getElementById('activity-desc').innerHTML =
    `<p>${currentActivity.description || ''}</p>`;
}

/* =======================
   LOAD ACTIVITY
======================= */
async function loadActivity(excludeId) {
  if (finished) return;

  const qs =
    `?mode=${encodeURIComponent(mode)}&duration=${encodeURIComponent(duration)}` +
    (excludeId ? `&excludeId=${excludeId}` : '');

  const data = await api('/activities' + qs);
  if (!data.activity) {
    alert('No activity found');
    return;
  }

  currentActivity = data.activity;
  sessionStorage.setItem('currentActivity', JSON.stringify(currentActivity));
  renderActivity();
}

/* =======================
   COMPLETE SESSION
======================= */
document.getElementById('done-btn').onclick = () => {
  if (finished) return;
  finished = true;

  document.getElementById('activity-area').classList.add('hidden');
  document.getElementById('controls').classList.add('hidden');
  document.getElementById('summary').classList.remove('hidden');

  document.getElementById('summary-details').innerHTML = `
    <p><strong>Activity:</strong> ${currentActivity.title}</p>
    <p><strong>Completed:</strong> ${new Date().toLocaleString()}</p>
    <p>Great job ðŸŒŸ</p>
  `;
};

/* =======================
   PHOTO (UPLOAD)
======================= */
const input = document.getElementById('photo-input');
const preview = document.getElementById('photo-preview');

input.addEventListener('change', () => {
  const file = input.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    photoBase64 = reader.result;
    preview.src = photoBase64;
    preview.style.display = 'block';
  };
  reader.readAsDataURL(file);
});

/* =======================
   PHOTO (CAMERA)
======================= */
const video = document.getElementById('camera');
const canvas = document.getElementById('snapshot');
const openCamBtn = document.getElementById('open-camera-btn');
const takeBtn = document.getElementById('take-photo-btn');

openCamBtn.onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;
  video.style.display = 'block';
  takeBtn.style.display = 'inline-block';
};

takeBtn.onclick = () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);

  photoBase64 = canvas.toDataURL('image/jpeg', 0.8);
  preview.src = photoBase64;
  preview.style.display = 'block';

  video.srcObject.getTracks().forEach(t => t.stop());
  video.style.display = 'none';
  takeBtn.style.display = 'none';
};

/* =======================
   SAVE SESSION
======================= */
document.getElementById('save-photo-btn').onclick = async () => {
  if (!finished) return;

  const completedAt = new Date().toISOString();

  await api('/sessions', {
    method: 'POST',
    body: JSON.stringify({
      mode,
      duration: Number(duration),
      activityId: currentActivity.id,
      activityTitle: currentActivity.title,
      startedAt,
      completedAt,
      photo: photoBase64 || null
    })
  });

  sessionStorage.clear();
  location.href = 'home.html';
};

/* =======================
   NAV BUTTONS
======================= */
document.getElementById('another-btn').onclick = () =>
  loadActivity(currentActivity?.id);

document.getElementById('back-home-btn').onclick = () => {
  sessionStorage.clear();
  location.href = 'home.html';
};

/* =======================
   INIT
======================= */
(async () => {
  const stored = sessionStorage.getItem('currentActivity');
  if (stored) {
    currentActivity = JSON.parse(stored);
    renderActivity();
  } else {
    await loadActivity();
  }
})();
</script>

</body>
</html>
