<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Little Wins â€” Stats</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="css/style.css">
  <script src="config.js"></script>
</head>
<body>
  <main class="card">
    <h1>Your Stats</h1>
    <p id="stats-summary" aria-live="polite"></p>
    <p id="stats-streak" aria-live="polite"></p>


    <h2>Last 7 Days</h2>
    <table id="days-table" class="table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Sessions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Sessions per Mode</h2>
    <table id="modes-table" class="table">
      <thead>
        <tr>
          <th>Mode</th>
          <th>Count</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="controls">
      <button id="back-home-btn">Back to Home</button>
    </div>
  </main>

  <script>
    const API_BASE = window.LW_CONFIG?.API_BASE || 'http://localhost:3000/api';
    const token = localStorage.getItem('lw_token');
    if (!token) window.location.href = 'index.html';

    async function api(path, opts = {}) {
      const headers = opts.headers || {};
      headers['Content-Type'] = 'application/json';
      headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(API_BASE + path, { ...opts, headers });
      if (res.status === 401) {
        localStorage.removeItem('lw_token');
        window.location.href = 'index.html';
        throw new Error('Unauthorized');
      }
      return res;
    }

    function renderDays(days) {
  const tbody = document.querySelector('#days-table tbody');
  tbody.innerHTML = '';

  const todayKey = new Date().toISOString().slice(0, 10);

  days.forEach(d => {
    const tr = document.createElement('tr');

    if (d.key === todayKey) {
      tr.classList.add('is-today'); //  adds the highlight
    }

    const tdDate = document.createElement('td');
    tdDate.textContent = d.label || d.key;

    const tdCount = document.createElement('td');
    tdCount.textContent = d.count;

    tr.appendChild(tdDate);
    tr.appendChild(tdCount);
    tbody.appendChild(tr);
  });
}


    function renderModes(modeCounts) {
      const tbody = document.querySelector('#modes-table tbody');
      tbody.innerHTML = '';

      Object.entries(modeCounts).forEach(([mode, count]) => {
        const tr = document.createElement('tr');

        const tdMode = document.createElement('td');
        tdMode.textContent = mode;

        const tdCount = document.createElement('td');
        tdCount.textContent = count;

        tr.appendChild(tdMode);
        tr.appendChild(tdCount);
        tbody.appendChild(tr);
      });
    }

    function calculateStreak(days) {
        let streak = 0;

        // days are ordered from oldest â†’ newest
        for (let i = days.length - 1; i >= 0; i--) {
            if (days[i].count > 0) {
                streak++;
            } else {
            break;
            }
        }
        return streak;
    }


    async function loadStats() {
        try {
            const r = await api('/sessions/stats');
            const data = await r.json();
            if (!r.ok) throw new Error(data.error || 'Could not load stats');

            document.getElementById('stats-summary').textContent =
                `Total completed sessions: ${data.total}`;

            renderDays(data.days || []);
            renderModes(data.modeCounts || {});

            // ðŸ”¥ streak logic
            const streak = calculateStreak(data.days || []);
            const streakEl = document.getElementById('stats-streak');

            if (streak > 0) {
                streakEl.textContent = `Streak: ${streak} day${streak === 1 ? '' : 's'} ðŸ”¥ Keep it going!`;
            } else {
                streakEl.textContent = 'No current streak yet â€” start one today âœ¨';
            }

        } catch (err) {
            document.getElementById('stats-summary').textContent =
                'Could not load stats: ' + (err.message || '');
        }
    }


    document.getElementById('back-home-btn').addEventListener('click', () => {
      window.location.href = 'home.html';
    });

    loadStats();
  </script>
</body>
</html>
